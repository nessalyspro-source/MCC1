<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi des signalements</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="vendor/phosphor/index.js"></script>
  <script src="vendor/supabase/supabase.js"></script>
  <style>
    :root { --ink:#0c2f35; --navy:#0f304b; --bg:#f3f8ff; }
    body { font-family:'Outfit',sans-serif; background: radial-gradient(140% 120% at 20% 0%, #f3f8ff 0%, var(--bg) 50%, #f9fbff 100%); color:#0c2f35; }
    .sidebar { background: linear-gradient(180deg, #0f304b, #0c2f35); border-right:1px solid rgba(255,255,255,0.05); color:#e8eef2; }
    .sidebar a { color:#cfd8dc; }
    .sidebar a:hover { background:rgba(255,255,255,0.06); color:#fff; }
    .nav-item.active { background:rgba(255,255,255,0.12); color:#fff; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
    .stat-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:18px; box-shadow:0 14px 40px rgba(15,48,75,0.08); }
    .report-card { background:#fff; border:1px solid #e2e8f0; border-radius:18px; padding:20px; box-shadow:0 18px 50px rgba(15,48,75,0.1); }
    .badge-soft { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid transparent; }
  </style>
</head>
<body class="flex h-screen">
  <aside class="w-64 sidebar flex flex-col p-6">
    <div class="text-xl font-bold tracking-wide mb-10 text-center text-slate-100">ESPACE <span class="text-sky-200">CLIENT</span></div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard_societe.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph-fill ph-squares-four text-lg"></i><span>Vue d'ensemble</span></a>
      <a href="societe_signalements.html" class="flex items-center gap-3 p-3 rounded-xl nav-item active font-medium"><i class="ph ph-warning-circle text-lg"></i><span>Suivi des signalements</span></a>
      <a href="societe_clients.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-users text-lg"></i><span>Suivi des clients</span></a>
      <a href="societe_contrats.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-file-text text-lg"></i><span>Suivi des contrats</span></a>
      <a href="societe_rapports.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-chart-bar text-lg"></i><span>Rapports</span></a>
      <a href="societe_cahier_des_charges.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-notebook text-lg"></i><span>Cahier des charges</span></a>
      <a href="societe_salaries.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-currency-eur text-lg"></i><span>Suivi des salaries</span></a>
      <a href="societe_pointages.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-timer text-lg"></i><span>Suivi des pointages</span></a>
      <a href="societe_conges.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition"><i class="ph ph-calendar-blank text-lg"></i><span>Suivi des demandes de congés</span></a>
    </nav>
    <a href="index.html" class="flex items-center gap-2 text-slate-200 hover:text-white transition mt-auto"><i class="ph ph-sign-out"></i> Déconnexion</a>
  </aside>

  <main class="flex-1 p-8 md:p-10 overflow-y-auto">
    <div id="content" class="max-w-6xl mx-auto space-y-8"></div>
  </main>

  <script>
    const supabaseUrl = 'https://fmfylsykljkvyurcprij.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtZnlsc3lrbGprdnl1cmNwcmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ3OTgsImV4cCI6MjA3OTE2MDc5OH0.hfgBflnh-nr1Ljfl5Chkp0y1EbZbm5XiyyDhsQcdSqE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, { auth: { persistSession:true, autoRefreshToken:true, storage: localStorage } });
    let currentSocieteId = null;
    let contrats = [];

    const root = document.getElementById('content');

    function renderLayout() {
      root.innerHTML = `
        <div class="flex items-start justify-between gap-4">
          <div>
            <p class="text-xs uppercase text-slate-500 font-semibold tracking-wide">Signalements</p>
            <h1 class="text-4xl font-bold text-slate-900">Suivi des signalements</h1>
            <p class="text-sm text-slate-600 mt-1">Filtrés automatiquement selon vos sites et contrats.</p>
          </div>
          <span id="last-refresh" class="px-3 py-2 rounded-full bg-white/70 border border-white/60 text-xs font-semibold text-slate-600 shadow-sm backdrop-blur">--</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="stats-cards"></div>
        <section class="space-y-4">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <h2 class="text-xl font-bold text-slate-900">Signalements</h2>
              <span id="badge-total" class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 text-sm font-semibold border border-slate-200">0</span>
            </div>
          </div>
          <div id="reports" class="space-y-4"></div>
        </section>
      `;
    }

    function counters(list) {
      const res = { nouveau:0, en_cours:0, cloture:0, total:list.length };
      list.forEach(s => {
        const st = (s.status || 'nouveau').toLowerCase();
        if (st.includes('clot')) res.cloture++; else if (st.includes('cours')) res.en_cours++; else res.nouveau++;
      });
      return res;
    }

    function renderStats(stats) {
      const el = document.getElementById('stats-cards');
      if (!el) return;
      el.innerHTML = `
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-slate-600">Nouveaux</p>
            <span class="h-10 w-10 rounded-full bg-amber-50 text-amber-500 flex items-center justify-center text-lg"><i class="ph ph-warning"></i></span>
          </div>
          <p class="text-3xl font-bold text-slate-900 mt-2">${stats.nouveau}</p>
          <p class="text-xs text-slate-500">A traiter</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-slate-600">En cours</p>
            <span class="h-10 w-10 rounded-full bg-sky-50 text-sky-500 flex items-center justify-center text-lg"><i class="ph ph-clock"></i></span>
          </div>
          <p class="text-3xl font-bold text-slate-900 mt-2">${stats.en_cours}</p>
          <p class="text-xs text-slate-500">Interventions</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-slate-600">Clôturés</p>
            <span class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-lg"><i class="ph ph-check-circle"></i></span>
          </div>
          <p class="text-3xl font-bold text-slate-900 mt-2">${stats.cloture}</p>
          <p class="text-xs text-slate-500">Résolus</p>
        </div>
      `;
      const badge = document.getElementById('badge-total');
      if (badge) badge.textContent = `${stats.total} signalement${stats.total>1?'s':''}`;
      const lr = document.getElementById('last-refresh');
      if (lr) lr.textContent = `Mis à jour ${new Date().toLocaleTimeString()}`;
    }

    async function updateStatus(id, status) {
      try {
        await supabaseClient.from('signalements').update({ status }).eq('id', id);
        const msg = status === 'en_cours' ? 'Prise en charge' : (status === 'cloture' ? 'Signalement resolu' : `Statut: ${status}`);
        await postMessage(id, `${msg} • ${new Date().toLocaleString()}`);
      } catch(e) {
        console.error(e);
        showToast('Mise à jour impossible', 'error');
      }
      await hydrate();
    }

    function renderReports(list) {
      const container = document.getElementById('reports');
      if (!container) return;
      if (!list.length) { container.innerHTML = '<div class="report-card text-sm text-amber-700">Aucun signalement trouvé pour vos sites.</div>'; return; }
      container.innerHTML = list.map(s => {
        const st = (s.status || 'nouveau').toLowerCase();
        const badge = st.includes('clot') ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : st.includes('cours') ? 'bg-sky-50 text-sky-700 border-sky-100' : 'bg-amber-50 text-amber-700 border-amber-100';
        const titre = s.titre || 'Signalement';
        const date = s.created_at ? new Date(s.created_at).toLocaleString() : '';
        return `
          <article class="report-card space-y-3">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="badge-soft ${badge}"><i class="ph-bold ph-warning-circle"></i> ${s.status || 'N/A'}</span>
              ${s.type ? `<span class="badge-soft bg-slate-100 text-slate-700 border-slate-200"><i class="ph-bold ph-tag"></i> ${s.type}</span>` : ''}
              ${s.site ? `<span class="badge-soft bg-white text-slate-700 border-slate-200"><i class="ph-bold ph-map-pin"></i> ${s.site}</span>` : ''}
            </div>
            <div class="grid md:grid-cols-[1.5fr,1fr] gap-3">
              <div class="space-y-1">
                <h3 class="text-lg font-semibold text-slate-900">${titre}</h3>
                <p class="text-sm text-slate-600">${s.description || ''}</p>
              </div>
              <div class="text-sm text-slate-600 space-y-1">
                ${date ? `<div class="flex items-center gap-2"><i class="ph-bold ph-calendar-blank"></i> ${date}</div>` : ''}
                ${s.contact_email ? `<div class="flex items-center gap-2"><i class="ph-bold ph-envelope"></i> ${s.contact_email}</div>` : ''}
                ${s.contact_tel ? `<div class="flex items-center gap-2"><i class="ph-bold ph-phone-call"></i> ${s.contact_tel}</div>` : ''}
              </div>
            </div>
            <div class="flex flex-wrap gap-2 pt-1">
              <button class="px-3 py-2 rounded bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100 text-xs font-semibold" data-action="take" data-id="${s.id}">Prendre en charge</button>
              <button class="px-3 py-2 rounded bg-emerald-50 text-emerald-700 border border-emerald-100 hover:bg-emerald-100 text-xs font-semibold" data-action="done" data-id="${s.id}">Marquer résolu</button>
              <button class="px-3 py-2 rounded bg-white border border-slate-200 text-xs font-semibold text-slate-700 hover:border-slate-300" data-action="detail" data-id="${s.id}">Détails & commentaires</button>
            </div>
          </article>
        `;
      }).join('');

      container.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = (e) => {
          const id = parseInt(btn.dataset.id, 10);
          const action = btn.dataset.action;
          const sig = list.find(x => x.id === id);
          if (!id || !action || !sig) return;
          if (action === 'take') updateStatus(id, 'en_cours');
          else if (action === 'done') updateStatus(id, 'cloture');
          else if (action === 'detail') openDetail(sig);
        };
      });
    }

    async function requireSession() {
      const { data } = await supabaseClient.auth.getSession();
      return data?.session || null;
    }

    async function ensureSocieteContext() {
      const session = await requireSession();
      const userId = session?.user?.id || '';
      const userEmail = session?.user?.email || '';
      if (!userId && !userEmail) return null;
      const { data: byAuth } = await supabaseClient.from('societes').select('id, nom, email_contact').eq('auth_id', userId).maybeSingle();
      if (byAuth?.id) { currentSocieteId = byAuth.id; return currentSocieteId; }
      if (userEmail) {
        const { data: byEmail } = await supabaseClient.from('societes').select('id, nom, email_contact').ilike('email_contact', userEmail).maybeSingle();
        if (byEmail?.id) { currentSocieteId = byEmail.id; return currentSocieteId; }
      }
      return null;
    }

    async function loadContrats() {
      if (!currentSocieteId) return [];
      const { data, error } = await supabaseClient.from('contrats').select('id, ref, residence, address').eq('societe_id', currentSocieteId);
      if (error) { console.error(error); return []; }
      contrats = data || [];
      return contrats;
    }

    async function loadSignalements() {
      const refs = contrats.map(c => c.ref).filter(Boolean);
      const sites = contrats.map(c => c.residence).filter(Boolean);
      if (!refs.length && !sites.length) return [];
      const filters = [];
      if (refs.length) filters.push(`contrat_ref.in.(${refs.join(',')})`);
      sites.forEach(site => filters.push(`site.ilike.%${encodeURIComponent(site)}%`));
      const query = supabaseClient.from('signalements').select('id, titre, type, description, status, site, created_at, contrat_ref, contact_email, contact_tel').order('created_at', { ascending:false }).limit(100);
      if (filters.length) query.or(filters.join(','));
      const { data, error } = await query;
      if (error) { console.error(error); return []; }
      return data || [];
    }

    document.addEventListener('DOMContentLoaded', async () => {
      renderLayout();
      const ctxOk = await ensureSocieteContext();
      if (!ctxOk) {
        root.innerHTML = '<div class="report-card text-sm text-amber-700">Session société introuvable. Merci de vous reconnecter.</div>';
        return;
      }
      await hydrate();
    });

    async function hydrate() {
      await loadContrats();
      const sigs = await loadSignalements();
      renderStats(counters(sigs));
      renderReports(sigs);
    }
  </script>
</body>
</html>
