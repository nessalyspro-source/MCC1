<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Espace Societe - Nessaly's</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="societe_theme.css">
  <script src="vendor/phosphor/index.js"></script>
  <script src="vendor/supabase/supabase.js"></script>
</head>
<body class="flex h-screen">
  <aside class="w-64 sidebar flex flex-col p-6">
    <div class="text-xl font-bold tracking-wide mb-10 text-center text-slate-200">ESPACE <span class="text-sand-200">CLIENT</span></div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard_societe.html" class="flex items-center gap-3 p-3 rounded-xl nav-item active font-medium"><i class="ph-fill ph-squares-four text-lg"></i><span>Vue d'ensemble</span></a>
      <a href="societe_signalements.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-warning-circle text-lg"></i><span>Suivi des signalements</span></a>
      <a href="societe_clients.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-users text-lg"></i><span>Suivi des clients</span></a>
      <a href="societe_contrats.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-file-text text-lg"></i><span>Suivi des contrats</span></a>
      <a href="societe_rapports.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-chart-bar text-lg"></i><span>Rapports</span></a>
      <a href="societe_salaries.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-currency-eur text-lg"></i><span>Suivi des salaries</span></a>
      <a href="societe_pointages.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-timer text-lg"></i><span>Suivi des pointages</span></a>
      <a href="societe_conges.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 text-slate-200 transition"><i class="ph ph-calendar-blank text-lg"></i><span>Suivi des demandes de conges</span></a>
    </nav>
    <a href="index.html" class="flex items-center gap-2 text-slate-300 hover:text-white transition mt-auto"><i class="ph ph-sign-out"></i> Deconnexion</a>
  </aside>

  <main class="flex-1 p-8 overflow-y-auto max-w-7xl mx-auto w-full bg-gray-50">
    <div class="flex items-center justify-between mb-6">
      <div>
        <span class="pill"><i class="ph-bold ph-buildings"></i> Portail Societe</span>
        <h1 class="text-3xl font-bold text-slate-900">Vue d'ensemble</h1>
        <p id="societe-label" class="text-sm text-slate-600"></p>
      </div>
      <span id="status-chip" class="px-3 py-1 rounded-full text-xs font-semibold bg-slate-200 text-slate-700">--</span>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <p class="text-xs font-semibold text-slate-500 uppercase">Contrats actifs</p>
        <p id="contrats-actifs" class="text-3xl font-bold text-slate-900">--</p>
        <p class="text-sm text-slate-500">Statut actif uniquement</p>
      </div>
      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <p class="text-xs font-semibold text-slate-500 uppercase">Contrats qui se terminent</p>
        <p id="contrats-fin" class="text-3xl font-bold text-amber-700">--</p>
        <p class="text-sm text-slate-500">Echeance &lt;= 30 jours</p>
      </div>
      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <p class="text-xs font-semibold text-slate-500 uppercase">Salaries</p>
        <p id="salaries-count" class="text-3xl font-bold text-slate-900">--</p>
        <p class="text-sm text-slate-500">Total des salaries associes</p>
      </div>
      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <p class="text-xs font-semibold text-slate-500 uppercase">CA HT Mensuel</p>
        <p id="ca-mensuel" class="text-3xl font-bold text-slate-900">--</p>
        <p id="ca-annuel" class="text-sm text-slate-500">CA annuel : --</p>
      </div>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-3 gap-4">
      <div class="card p-5 xl:col-span-2 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-500 uppercase">Alertes</p>
            <h2 class="text-lg font-semibold text-slate-900">Contrats en fin prochaine</h2>
          </div>
          <span id="alert-count" class="text-xs px-3 py-1 rounded-full bg-amber-100 text-amber-700">--</span>
        </div>
        <div id="alert-list" class="divide-y divide-slate-200 text-sm">
          <p class="text-slate-500 py-3">Chargement...</p>
        </div>
      </div>
      <div class="card p-5 space-y-3 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <p class="text-xs font-semibold text-slate-500 uppercase">Actions rapides</p>
        <a href="societe_clients.html" class="w-full inline-flex items-center justify-between px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 text-sm">Creer un client <i class="ph-bold ph-arrow-up-right"></i></a>
        <a href="societe_contrats.html" class="w-full inline-flex items-center justify-between px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 text-sm">Creer un contrat <i class="ph-bold ph-arrow-up-right"></i></a>
        <a href="societe_salaries.html" class="w-full inline-flex items-center justify-between px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 text-sm">Creer un salarie <i class="ph-bold ph-arrow-up-right"></i></a>
      </div>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-2 gap-4 mt-6">
      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-500 uppercase">Nouveaux signalements</p>
            <h2 class="text-lg font-semibold text-slate-900">Derniers incidents par site</h2>
          </div>
          <span id="recent-count" class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-700">--</span>
        </div>
        <div id="recent-signalements" class="space-y-3 text-sm">
          <p class="text-slate-500">Chargement...</p>
        </div>
      </div>

      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-500 uppercase">Facturation</p>
            <h2 class="text-lg font-semibold text-slate-900">Derniere facture</h2>
          </div>
        </div>
        <p id="facture-date" class="text-xl font-semibold text-slate-900 mb-1">--</p>
        <p id="facture-amount" class="text-sm text-slate-500">--</p>
      </div>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-2 gap-4 mt-6">
      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-500 uppercase">Pointages</p>
            <h2 class="text-lg font-semibold text-slate-900">Agents sans pointage recent</h2>
          </div>
          <span id="anomaly-count" class="text-xs px-3 py-1 rounded-full bg-amber-100 text-amber-700">--</span>
        </div>
        <div id="pointage-anomalies" class="space-y-3 text-sm">
          <p class="text-slate-500">Chargement...</p>
        </div>
      </div>

      <div class="card p-5 border border-gray-100 rounded-3xl hover:shadow-md transition">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-500 uppercase">Presence</p>
            <h2 class="text-lg font-semibold text-slate-900">Pointages par site (30j)</h2>
          </div>
        </div>
        <div id="pointage-sites" class="space-y-3 text-sm">
          <p class="text-slate-500">Chargement...</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const supabaseUrl = 'https://fmfylsykljkvyurcprij.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtZnlsc3lrbGprdnl1cmNwcmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ3OTgsImV4cCI6MjA3OTE2MDc5OH0.hfgBflnh-nr1Ljfl5Chkp0y1EbZbm5XiyyDhsQcdSqE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    let societeId = null;
    let userId = null;

    function formatCurrency(n) { return Number(n || 0).toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + ' EUR'; }
    function formatDate(d) { return d ? new Date(d).toLocaleString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '--'; }

    async function ensureSociete() {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      userId = sessionData?.session?.user?.id || null;
      if (!userId) return null;
      const { data, error } = await supabaseClient.from('societes').select('id, nom, statut').eq('auth_id', userId).single();
      if (error || !data) return null;
      societeId = data.id;
      document.getElementById('societe-label').textContent = data.nom ? `Portail : ${data.nom}` : '';
      document.getElementById('status-chip').textContent = data.statut || 'actif';
      document.getElementById('status-chip').className = 'px-3 py-1 rounded-full text-xs font-semibold ' + ((data.statut || '').toLowerCase() === 'actif' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-700');
      return societeId;
    }

    function computeCa(contrats) {
      let mensual = 0;
      contrats.forEach(c => {
        const ht = Number(c.prix_ht || 0);
        const period = (c.periodicite || '').toLowerCase();
        if (period === 'trimestriel') mensual += ht / 3;
        else if (period === 'annuel') mensual += ht / 12;
        else mensual += ht; // mensuel par defaut
      });
      return { mensual, annuel: mensual * 12 };
    }

    function renderAlerts(list) {
      const alertList = document.getElementById('alert-list');
      document.getElementById('alert-count').textContent = list.length;
      if (!list.length) { alertList.innerHTML = '<p class="text-slate-500 py-3">Aucun contrat proche de la fin.</p>'; return; }
      alertList.innerHTML = list.map(c => `
        <div class="py-2 flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-slate-800">${c.client_name || 'Contrat'}</p>
            <p class="text-xs text-slate-500">Fin le ${c.date_fin || 'N/A'} - Ref ${c.ref || ''}</p>
          </div>
          <span class="text-[11px] px-2 py-1 rounded-full bg-amber-100 text-amber-700">Fin proche</span>
        </div>
      `).join('');
    }

    async function loadStats() {
      if (!societeId) {
        ['contrats-actifs','contrats-fin','salaries-count','ca-mensuel','ca-annuel','facture-date','facture-amount'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '--';
        });
        return;
      }
      const [contratsRes, facturesRes] = await Promise.all([
        supabaseClient.from('contrats').select('*').eq('societe_id', societeId),
        supabaseClient.from('factures').select('*').eq('societe_id', societeId).order('created_at', { ascending: false })
      ]);
      const contrats = contratsRes.data || [];
      let salaries = [];
      const contratIds = contrats.map(c => c.id).filter(Boolean);
      if (contratIds.length) {
        const { data: salData, error: salError } = await supabaseClient
          .from('salaries')
          .select('id, contrat_id')
          .in('contrat_id', contratIds);
        if (!salError) salaries = salData || [];
      }
      const actifs = contrats.filter(c => (c.statut || '').toLowerCase() === 'actif');
      const now = new Date();
      const finProche = contrats.filter(c => {
        if (!c.date_fin) return false;
        const d = new Date(c.date_fin);
        const diff = (d - now) / (1000*60*60*24);
        return diff >= 0 && diff <= 30;
      });
      const ca = computeCa(actifs);
      document.getElementById('contrats-actifs').textContent = actifs.length;
      document.getElementById('contrats-fin').textContent = finProche.length;
      document.getElementById('salaries-count').textContent = salaries.length;
      document.getElementById('ca-mensuel').textContent = formatCurrency(ca.mensual);
      document.getElementById('ca-annuel').textContent = `CA annuel : ${formatCurrency(ca.annuel)}`;
      renderAlerts(finProche);

      const factures = facturesRes.data || [];
      if (!factures.length) {
        const fd = document.getElementById('facture-date');
        const fa = document.getElementById('facture-amount');
        if (fd) fd.textContent = 'Aucune facture';
        if (fa) fa.textContent = '';
      } else {
        const f = factures[0];
        const fd = document.getElementById('facture-date');
        const fa = document.getElementById('facture-amount');
        if (fd) fd.textContent = f.periode || 'Periode non renseignee';
        if (fa) fa.textContent = f.montant ? formatCurrency(f.montant) : '';
      }
    }

    async function loadPointageInsights() {
      const anomalyBox = document.getElementById('pointage-anomalies');
      const anomalyCount = document.getElementById('anomaly-count');
      const siteBox = document.getElementById('pointage-sites');
      if (!societeId) {
        anomalyBox.innerHTML = '<p class="text-slate-500">Connectez-vous.</p>';
        siteBox.innerHTML = '<p class="text-slate-500">Connectez-vous.</p>';
        if (anomalyCount) anomalyCount.textContent = '--';
        return;
      }
      const { data: contrats, error: cErr } = await supabaseClient.from('contrats').select('id, residence').eq('societe_id', societeId);
      if (cErr || !contrats?.length) {
        anomalyBox.innerHTML = '<p class="text-slate-500">Aucun contrat associe.</p>';
        siteBox.innerHTML = '<p class="text-slate-500">Aucun site.</p>';
        if (anomalyCount) anomalyCount.textContent = '0';
        return;
      }
      const contractIds = contrats.map(c => c.id).filter(Boolean);
      const contractMap = new Map(contrats.map(c => [c.id, c.residence || 'Site']));
      const { data: salaries, error: sErr } = await supabaseClient
        .from('salaries')
        .select('id, prenom, nom, ref, contrat_id')
        .in('contrat_id', contractIds);
      if (sErr || !salaries?.length) {
        anomalyBox.innerHTML = '<p class="text-slate-500">Aucun salarie associe.</p>';
        siteBox.innerHTML = '<p class="text-slate-500">Aucun pointage.</p>';
        if (anomalyCount) anomalyCount.textContent = '0';
        return;
      }
      const salarieIds = salaries.map(s => s.id);
      const salarieMap = new Map(salaries.map(s => [s.id, s]));
      const since = new Date();
      since.setDate(since.getDate() - 30);
      let query = supabaseClient
        .from('pointages')
        .select('id, type, mode, site, salarie_id, contrat_id, created_at')
        .gte('created_at', since.toISOString())
        .order('created_at', { ascending: false })
        .limit(2000);
      if (salarieIds.length) query = query.in('salarie_id', salarieIds);
      const { data: pointages, error: pErr } = await query;
      if (pErr) {
        anomalyBox.innerHTML = '<p class="text-slate-500">Erreur de chargement des pointages.</p>';
        siteBox.innerHTML = '<p class="text-slate-500">Erreur.</p>';
        if (anomalyCount) anomalyCount.textContent = '--';
        return;
      }
      // Last pointage par salarie
      const lastBySalarie = new Map();
      (pointages || []).forEach(p => {
        if (!lastBySalarie.has(p.salarie_id)) lastBySalarie.set(p.salarie_id, p);
      });
      const anomalies = [];
      const now = Date.now();
      lastBySalarie.forEach((p, sid) => {
        const s = salarieMap.get(sid);
        const agent = s ? `${s.prenom || ''} ${s.nom || ''}`.trim() || s.ref || '' : 'Salarie';
        const last = p?.created_at ? new Date(p.created_at).getTime() : 0;
        const days = last ? Math.round((now - last) / (1000*60*60*24)) : 999;
        if (days >= 3) anomalies.push({ agent, days, date: p?.created_at || '' });
      });
      // Site stats
      const siteStats = new Map();
      (pointages || []).forEach(p => {
        const key = p.site || contractMap.get(p.contrat_id) || 'Site';
        if (!siteStats.has(key)) siteStats.set(key, { total:0, entree:0, sortie:0 });
        const rec = siteStats.get(key);
        rec.total += 1;
        if ((p.type || '').toLowerCase() === 'entree') rec.entree += 1;
        if ((p.type || '').toLowerCase() === 'sortie') rec.sortie += 1;
      });

      if (anomalyCount) anomalyCount.textContent = anomalies.length;
      anomalyBox.innerHTML = anomalies.length
        ? anomalies.slice(0,8).map(a => `
          <div class="flex items-center justify-between rounded-lg border border-amber-100 bg-amber-50 px-3 py-2">
            <div>
              <p class="font-semibold text-slate-900">${a.agent}</p>
              <p class="text-xs text-slate-600">Dernier pointage il y a ${a.days} jours</p>
            </div>
            <span class="px-2 py-1 text-[11px] rounded-full bg-amber-200 text-amber-800">${a.date ? new Date(a.date).toLocaleDateString() : 'N/A'}</span>
          </div>
        `).join('') + (anomalies.length > 8 ? `<p class="text-xs text-slate-500">+ ${anomalies.length - 8} autres</p>` : '')
        : '<p class="text-slate-500">Tous les agents ont pointe recemment.</p>';

      if (!siteStats.size) {
        siteBox.innerHTML = '<p class="text-slate-500">Aucun pointage sur 30 jours.</p>';
      } else {
        siteBox.innerHTML = Array.from(siteStats.entries()).slice(0,8).map(([site, stats]) => `
          <div class="flex items-center justify-between rounded-lg border border-slate-200 px-3 py-2">
            <div>
              <p class="font-semibold text-slate-900">${site}</p>
              <p class="text-xs text-slate-500">Entrees ${stats.entree} · Sorties ${stats.sortie}</p>
            </div>
            <span class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700">${stats.total} pointages</span>
          </div>
        `).join('');
      }
    }

    async function loadSignalementsRecents() {
      const container = document.getElementById('recent-signalements');
      const badge = document.getElementById('recent-count');
      if (!societeId) { container.innerHTML = '<p class="text-slate-500">Connectez-vous.</p>'; badge.textContent = '--'; return; }

      const { data: contrats, error: contratsError } = await supabaseClient.from('contrats').select('id, ref, site_nom').eq('societe_id', societeId);
      if (contratsError || !contrats?.length) { container.innerHTML = '<p class="text-slate-500">Aucun contrat associe.</p>'; badge.textContent = '0'; return; }

      const ids = contrats.map(c => c.id);
      const { data, error } = await supabaseClient
        .from('signalements')
        .select('id, contrat_id, contrat_ref, site, adresse, statut, created_at, titre, type, priorite')
        .in('contrat_id', ids)
        .order('created_at', { ascending: false })
        .limit(6);

      if (error) { container.innerHTML = '<p class="text-red-600 text-sm">Erreur de chargement.</p>'; badge.textContent = '--'; return; }
      if (!data?.length) { container.innerHTML = '<p class="text-slate-500">Aucun signalement recent.</p>'; badge.textContent = '0'; return; }

      badge.textContent = `${data.length} recents`;
      container.innerHTML = data.map(s => {
        const stat = (s.statut || '').toLowerCase();
        const colors = stat === 'cloture' ? 'bg-emerald-100 text-emerald-700' : stat === 'en_cours' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-700';
        return `
          <div class="p-3 rounded-lg border border-slate-100 bg-slate-50/60">
            <div class="flex items-start justify-between gap-2">
              <div>
                <p class="font-semibold text-slate-900">${s.titre || 'Signalement'}</p>
                <p class="text-xs text-slate-500">${s.site || ''} ${s.adresse ? ' · ' + s.adresse : ''}</p>
                <p class="text-[11px] text-slate-500">Contrat ${s.contrat_ref || ''}</p>
              </div>
              <span class="px-2 py-1 rounded-full text-[11px] font-semibold ${colors}">${stat || 'nouveau'}</span>
            </div>
            <p class="text-xs text-slate-500 mt-1">Cree le ${formatDate(s.created_at)}</p>
          </div>
        `;
      }).join('');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await ensureSociete();
      await loadStats();
      await loadSignalementsRecents();
      await loadPointageInsights();
    });
  </script>
</body>
</html>

