<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace Employés</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="vendor/phosphor/index.js"></script>
    <script src="vendor/supabase/supabase.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #F0FDF4; overflow: hidden; color: #14532D; }
        
        /* Fond Animé (Feuilles/Vert) */
        .blob { position: absolute; border-radius: 50%; filter: blur(70px); opacity: 0.4; z-index: -1; animation: float 20s infinite ease-in-out reverse; }
        .blob-1 { width: 600px; height: 600px; background: #86EFAC; top: -20%; right: -10%; }
        .blob-2 { width: 400px; height: 400px; background: #BBF7D0; bottom: -10%; left: -10%; animation-delay: -2s; }
        
        @keyframes float { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(30px) scale(1.05); } 100% { transform: translateY(0) scale(1); } }

        /* Carte */
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(22, 163, 74, 0.1);
            border-radius: 30px;
        }

        /* Inputs */
        .input-field { background: #F0FDF4; border: 1px solid #DCFCE7; transition: all 0.3s; }
        .input-field:focus { background: white; border-color: #22C55E; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.1); transform: translateY(-1px); outline: none; }

        /* Boutons */
        .btn-primary {
            background: linear-gradient(135deg, #16A34A 0%, #22C55E 100%);
            transition: all 0.3s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px -4px rgba(22, 197, 94, 0.4); }
        
        .btn-secondary {
            background: white; border: 2px solid #F0FDF4; color: #15803D; transition: all 0.3s;
        }
        .btn-secondary:hover { border-color: #22C55E; color: #166534; background: #F0FDF4; }

        .hidden-panel { display: none; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        :root {
      --ink: #0c2f35;
      --navy: #0f304b;
      --red: #ce3c35;
      --sand: #b58a64;
      --bg: #f7f5f2;
    }
    body { background: radial-gradient(140% 120% at 20% 0%, #f0f7f8 0%, var(--bg) 45%, #fdfdfb 100%); color: #0c2f35; }
    .sidebar { background: linear-gradient(180deg, #0f304b, #0c2f35); border-right: 1px solid rgba(255,255,255,0.05); color: #e8eef2; }
    .sidebar a { color: #cfd8dc; }
    .sidebar a:hover { background: rgba(255,255,255,0.06); color: #ffffff; }
    .nav-item.active { background: rgba(255,255,255,0.12); color: #ffffff; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
    .pill { background: rgba(12,47,53,0.08); color: #0f304b; }
    .gradient-chip { background: linear-gradient(120deg, var(--red), var(--navy)); box-shadow: 0 10px 30px rgba(12,47,53,0.22); }
    .card-surface { border: 1px solid #e7e5e0; box-shadow: 0 12px 40px rgba(12,47,53,0.08); }
</style>
</head>
<body class="flex h-screen items-center justify-center p-4">

    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="login-card w-full max-w-md p-8 md:p-10 relative">
        
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-green-100 text-green-600 mb-4 shadow-sm">
                <i class="ph-fill ph-plant text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-green-900">Espace Employés</h1>
            <p class="text-green-600/70 text-sm mt-2">Vie de l'entreprise & RH</p>
        </div>

        <!-- FORMULAIRE 1: CONNEXION CLASSIQUE (Email) -->
        <div id="login-form" class="space-y-5">
            <div>
                <label class="block text-xs font-bold text-green-700/50 uppercase mb-1.5 ml-1">Email</label>
                <input id="login-email" type="email" class="input-field w-full rounded-xl px-4 py-3.5 text-sm text-green-900" placeholder="prenom.nom@nessaly.group">
            </div>
            
            <div>
                <div class="flex justify-between mb-1.5 ml-1">
                    <label class="block text-xs font-bold text-green-700/50 uppercase">Mot de passe</label>
                    <a href="#" class="text-xs text-green-600 hover:text-green-800 font-medium transition-colors">Oublié ?</a>
                </div>
                <input id="login-password" type="password" class="input-field w-full rounded-xl px-4 py-3.5 text-sm" placeholder="********">
            </div>

            <button id="login-btn" class="btn-primary w-full text-white font-bold py-3.5 rounded-xl mt-2">
                Accéder à mon espace
            </button>

            <div class="relative py-3">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-green-100"></div></div>
                <div class="relative flex justify-center text-xs"><span class="bg-white px-3 text-green-400">Nouvel arrivant ?</span></div>
            </div>

            <button onclick="toggleForms('register')" class="btn-secondary w-full font-bold py-3.5 rounded-xl">
                Première Connexion
            </button>
        </div>

        <!-- FORMULAIRE 2: PREMIÈRE CONNEXION (Matricule) -->
        <div id="register-form" class="hidden-panel space-y-5">
            <div class="bg-green-50 border border-green-100 p-4 rounded-xl flex gap-3">
                <i class="ph-fill ph-identification-badge text-green-500 text-xl"></i>
                <p class="text-xs text-green-800 leading-relaxed">Pour activer votre compte, saisissez votre <strong>Matricule</strong> (ex: EMP-001) et le code temporaire.</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-green-700/50 uppercase mb-1.5 ml-1">Votre Matricule</label>
                <input id="matricule-input" type="text" class="input-field w-full rounded-xl px-4 py-3.5 text-sm font-bold text-green-900 placeholder-green-200" placeholder="EMP-XXXX">
            </div>

            <div>
                <label class="block text-xs font-bold text-green-700/50 uppercase mb-1.5 ml-1">Code Temporaire</label>
                <input id="temp-code-input" type="text" class="input-field w-full rounded-xl px-4 py-3.5 text-sm font-mono text-center tracking-wider bg-white" placeholder="123456">
            </div>

            <button id="register-btn" class="btn-primary w-full text-white font-bold py-3.5 rounded-xl mt-2">
                Valider mon accès
            </button>
            
            <button onclick="toggleForms('login')" class="w-full text-green-400 hover:text-green-600 text-sm font-medium py-2 mt-2 transition-colors">
                Retour connexion
            </button>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center pt-6 border-t border-green-50">
            <a href="index.html" class="inline-flex items-center gap-2 text-green-400/70 hover:text-green-600 transition-colors text-sm font-medium group">
                <i class="ph ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> Retour
            </a>
        </div>

    </div>

    <script>
        const supabaseUrl = 'https://fmfylsykljkvyurcprij.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtZnlsc3lrbGprdnl1cmNwcmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ3OTgsImV4cCI6MjA3OTE2MDc5OH0.hfgBflnh-nr1Ljfl5Chkp0y1EbZbm5XiyyDhsQcdSqE';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
            auth: { persistSession: true, autoRefreshToken: true, storage: localStorage }
        });

        function toggleForms(target) {
            document.getElementById('login-form').style.display = target === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = target === 'register' ? 'block' : 'none';
        }

        function saveSession(session) {
            if (session) localStorage.setItem('supabaseSession', JSON.stringify(session));
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!email || !password) { alert('Email et mot de passe requis'); return; }
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) { alert('Connexion impossible: ' + error.message); return; }
            saveSession(data.session);
            window.location.href = 'dashboard_employe.html';
        }

        async function handleFirstAccess(e) {
            e.preventDefault();
            const matricule = document.getElementById('matricule-input').value.trim();
            const tempCode = document.getElementById('temp-code-input').value.trim();
            if (!matricule || !tempCode) { alert('Matricule et code temporaire requis'); return; }
            // Rechercher de manière robuste le matricule (sensibilité casse/espaces)
            const cleanedRef = matricule.toUpperCase();
            let salarie = null;
            let error = null;
            ({ data: salarie, error } = await supabaseClient
                .from('salaries')
                .select('id, email, prenom, nom')
                .eq('ref', cleanedRef)
                .maybeSingle());
            if ((!salarie || error) && matricule) {
                const { data: salarieIlike, error: errIlike } = await supabaseClient
                    .from('salaries')
                    .select('id, email, prenom, nom')
                    .ilike('ref', matricule)
                    .maybeSingle();
                salarie = salarieIlike;
                error = errIlike;
            }
            if (!salarie) { alert('Matricule introuvable'); return; }
            if (!salarie.email) { alert('Aucun email renseigné pour ce salarié. Contactez un administrateur.'); return; }

            // Tente un signup (première activation) puis fallback sur login si le compte existe déjà
            const { data: signData, error: signErr } = await supabaseClient.auth.signUp({
                email: salarie.email,
                password: tempCode,
                options: { data: { ref: matricule, prenom: salarie.prenom, nom: salarie.nom } }
            });
            if (signErr && signErr.message?.toLowerCase().includes('already registered')) {
                const { data: loginData, error: loginErr } = await supabaseClient.auth.signInWithPassword({ email: salarie.email, password: tempCode });
                if (loginErr) { alert('Accès impossible: ' + loginErr.message); return; }
                saveSession(loginData.session);
                window.location.href = 'dashboard_employe.html';
                return;
            }
            if (signErr) { alert('Activation impossible: ' + signErr.message); return; }
            saveSession(signData.session);
            window.location.href = 'dashboard_employe.html';
        }

        document.getElementById('login-btn')?.addEventListener('click', handleEmailLogin);
        document.getElementById('register-btn')?.addEventListener('click', handleFirstAccess);
    </script>
</body>
</html>



