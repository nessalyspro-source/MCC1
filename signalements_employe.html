<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signalements - Employé</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="vendor/phosphor/index.js"></script>
  <script src="vendor/supabase/supabase.js"></script>
  <style>
    body { font-family:'Outfit',sans-serif; background: radial-gradient(140% 120% at 20% 0%, #f0f7f8 0%, #f7f5f2 45%, #fdfdfb 100%); color:#0c2f35; }
    .sidebar { background: linear-gradient(180deg, #0f304b, #0c2f35); color:#e8eef2; }
    .sidebar a { color:#cfd8dc; }
    .sidebar a:hover { background:rgba(255,255,255,0.06); color:#fff; }
    .nav-item.active { background:rgba(255,255,255,0.12); color:#fff; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
    .card { background:#fff; border:1px solid #e7e5e0; border-radius:18px; box-shadow:0 10px 30px rgba(12,47,53,0.08); }
  </style>
</head>
<body class="flex h-screen">
  <aside class="w-64 sidebar flex flex-col p-6">
    <div class="text-xl font-bold tracking-wide mb-10 text-center text-white">ESPACE <span class="text-green-300">RH</span></div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard_employe.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-slate-200 transition"><i class="ph-fill ph-house"></i> Accueil</a>
      <a href="planning_employe.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-slate-200 transition"><i class="ph ph-calendar"></i> Planning</a>
      <a href="signalements_employe.html" class="flex items-center gap-3 p-3 rounded-xl nav-item active font-medium"><i class="ph ph-warning-circle"></i> Signalements</a>
      <a href="bulletins_employe.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-slate-200 transition"><i class="ph ph-files"></i> Bulletins</a>
    </nav>
    <a href="index.html" class="flex items-center gap-2 text-slate-200 hover:text-white transition mt-auto"><i class="ph ph-sign-out"></i> Déconnexion</a>
  </aside>

  <main class="flex-1 p-6 md:p-8 overflow-y-auto">
    <div class="card p-5 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase text-slate-500 font-semibold">Signalements</p>
          <h1 class="text-2xl font-bold text-slate-900">Suivi des signalements</h1>
          <p class="text-sm text-slate-500">Confirmez la lecture, échangez et marquez résolu.</p>
        </div>
        <span id="sig-count" class="px-3 py-1 rounded-full text-xs bg-slate-100 text-slate-700">--</span>
      </div>
    </div>

    <div class="space-y-3" id="sig-list"></div>
  </main>

  <div id="toast" class="fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none text-sm transition-all duration-300">Message</div>

  <div id="detail-backdrop" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm opacity-0 pointer-events-none transition"></div>
  <aside id="detail-panel" class="fixed inset-y-0 right-0 w-full sm:w-[520px] bg-white shadow-2xl transform translate-x-full opacity-0 transition flex flex-col">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
      <div>
        <p class="text-xs uppercase text-slate-500">Détail signalement</p>
        <h2 id="detail-title" class="text-lg font-semibold text-slate-900">Signalement</h2>
      </div>
      <button id="detail-close" class="p-2 rounded-full hover:bg-slate-100"><i class="ph-bold ph-x"></i></button>
    </div>
    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="detail-content"></div>
  </aside>

  <script>
    const supabaseUrl = 'https://fmfylsykljkvyurcprij.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtZnlsc3lrbGprdnl1cmNwcmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ3OTgsImV4cCI6MjA3OTE2MDc5OH0.hfgBflnh-nr1Ljfl5Chkp0y1EbZbm5XiyyDhsQcdSqE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, { auth:{ persistSession:true, autoRefreshToken:true, storage:localStorage } });
    const bucketSignalements = 'signalements-documents';

    let currentEmail = '';
    let currentList = [];
    function showToast(msg, type='info') {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('opacity-0','pointer-events-none');
      el.style.backgroundColor = type === 'error' ? '#b91c1c' : '#0f172a';
      setTimeout(() => el.classList.add('opacity-0','pointer-events-none'), 2000);
    }

    async function requireSession() {
      const { data } = await supabaseClient.auth.getSession();
      if (data?.session) return data.session;
      const stored = localStorage.getItem('supabaseSession');
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          const { data: setData } = await supabaseClient.auth.setSession({ access_token: parsed?.access_token, refresh_token: parsed?.refresh_token });
          return setData?.session || null;
        } catch (e) { console.warn(e); }
      }
      return null;
    }

    function render(list) {
      const container = document.getElementById('sig-list');
      const badge = document.getElementById('sig-count');
      badge.textContent = `${list.length} signalement${list.length>1?'s':''}`;
      if (!list.length) { container.innerHTML = '<p class="text-slate-500">Aucun signalement.</p>'; return; }
      container.innerHTML = list.map(s => {
        const date = s.created_at ? new Date(s.created_at).toLocaleDateString() : '';
        const status = s.status || 'nouveau';
        const badgeColor = status === 'resolu' ? 'bg-emerald-100 text-emerald-700' : status === 'lu' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700';
        return `<div class="card p-4 signalement-card" data-id="${s.id}">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-semibold text-slate-900">${s.titre || 'Signalement'}</div>
              <p class="text-xs text-slate-500">${date} · ${s.type || ''}</p>
            </div>
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${badgeColor}">${status}</span>
          </div>
          <p class="text-sm text-slate-700 mt-1">${s.description || ''}</p>
          <p class="text-xs text-slate-500 mt-1">${s.site || ''}</p>
          <div class="mt-3 flex flex-wrap gap-2 text-xs">
            <button data-id="${s.id}" data-action="lu" class="px-3 py-2 rounded bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100">Marquer lu</button>
            <button data-id="${s.id}" data-action="resolu" class="px-3 py-2 rounded bg-emerald-50 text-emerald-700 border border-emerald-100 hover:bg-emerald-100">Marquer résolu</button>
          </div>
        </div>`;
      }).join('');
    }

    async function loadSignalements() {
      const session = await requireSession();
      if (!session) { window.location.href = 'employes_login.html'; return; }
      currentEmail = session.user?.email || '';
      if (!currentEmail) { document.getElementById('sig-list').innerHTML = '<p class="text-red-500">Email absent.</p>'; return; }
      const { data: salarie } = await supabaseClient.from('salaries').select('contrat_id, contrats:contrat_id(ref)').ilike('email', currentEmail).maybeSingle();
      const contratRef = salarie?.contrats?.ref || null;
      let query = supabaseClient
        .from('signalements')
        .select('id, titre, type, description, status, site, created_at, contact_email, contrat_ref')
        .order('created_at', { ascending:false })
        .limit(50);
      const filters = [`contact_email.ilike.${currentEmail}`];
      if (contratRef) filters.push(`contrat_ref.eq.${contratRef}`);
      query = query.or(filters.join(','));
      const { data, error } = await query;
      if (error) { console.error(error); showToast('Chargement impossible', 'error'); return; }
      currentList = data || [];
      render(currentList);
    }

    async function updateStatus(id, status) {
      const { error } = await supabaseClient.from('signalements').update({ status }).eq('id', id);
      if (error) { console.error(error); showToast('Mise à jour impossible', 'error'); return; }
      showToast('Statut mis à jour');
      loadSignalements();
    }

    document.getElementById('sig-list').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      const card = e.target.closest('.signalement-card');
      if (btn) {
        const id = parseInt(btn.dataset.id, 10);
        const action = btn.dataset.action;
        if (action === 'lu') updateStatus(id, 'lu');
        if (action === 'resolu') updateStatus(id, 'resolu');
        return;
      }
      if (card) {
        const id = parseInt(card.dataset.id, 10);
        const sig = currentList.find(x => x.id === id);
        if (sig) openDetail(sig);
      }
    });

    document.addEventListener('DOMContentLoaded', loadSignalements);

    function closeDetail() {
      document.getElementById('detail-panel').classList.add('translate-x-full','opacity-0');
      document.getElementById('detail-backdrop').classList.add('opacity-0','pointer-events-none');
      document.body.style.overflow = '';
    }
    document.getElementById('detail-close').addEventListener('click', closeDetail);
    document.getElementById('detail-backdrop').addEventListener('click', closeDetail);

    async function loadPhotos(sigId) {
      const basePath = `signalements/${sigId}`;
      const folders = [basePath, `${basePath}/messages`];
      const allFiles = [];
      for (const path of folders) {
        const { data, error } = await supabaseClient.storage.from(bucketSignalements).list(path, { limit: 50, sortBy:{ column:'name', order:'desc' } });
        if (error) { console.warn(error); continue; }
        const withUrls = await Promise.all((data||[]).map(async f => {
          const fullPath = `${path}/${f.name}`;
          const { data: signed } = await supabaseClient.storage.from(bucketSignalements).createSignedUrl(fullPath, 3600);
          return { name:f.name, url: signed?.signedUrl, path: fullPath };
        }));
        allFiles.push(...withUrls);
      }
      return allFiles;
    }

    async function loadMessages(sigId) {
      try {
        const { data, error } = await supabaseClient
          .from('signalement_messages')
          .select('id, author, message, created_at')
          .eq('signalement_id', sigId)
          .order('created_at', { ascending:true });
        if (error) { console.warn(error); return []; }
        return data || [];
      } catch(e) { console.warn(e); return []; }
    }

    async function postMessage(sigId, message) {
      if (!message.trim()) return;
      try {
        await supabaseClient.from('signalement_messages').insert([{ signalement_id: sigId, author: currentEmail, message }]);
      } catch(e) { console.warn(e); showToast('Impossible d\'ajouter le commentaire','error'); }
    }

    async function uploadMessageImage(sigId, file) {
      if (!file) return;
      const path = `signalements/${sigId}/messages/${Date.now()}-${file.name}`;
      const { error } = await supabaseClient.storage.from(bucketSignalements).upload(path, file, { upsert:false, contentType:file.type });
      if (error) { console.warn(error); showToast('Upload image impossible','error'); return; }
      const { data: signed } = await supabaseClient.storage.from(bucketSignalements).createSignedUrl(path, 3600);
      await postMessage(sigId, `[Image] ${signed?.signedUrl || ''}`);
    }

    function renderMessages(list) {
      const area = document.getElementById('msg-area');
      if (!area) return;
      if (!list.length) { area.innerHTML = '<p class="text-slate-500 text-sm">Aucun message.</p>'; return; }
      area.innerHTML = list.map(m => {
        const date = m.created_at ? new Date(m.created_at).toLocaleString() : '';
        const isMe = m.author && currentEmail && m.author.toLowerCase() === currentEmail.toLowerCase();
        const classes = isMe ? 'bg-emerald-50 border-emerald-100 text-emerald-900 ml-auto' : 'bg-slate-50 border-slate-200 text-slate-800';
        const align = isMe ? 'text-right' : 'text-left';
        let body = m.message || '';
        if (body.startsWith('[Image]')) {
          const url = body.replace('[Image]', '').trim();
          body = `<a href="${url}" target="_blank" rel="noopener" class="block rounded-lg overflow-hidden border border-slate-200"><img src="${url}" class="w-full h-32 object-cover"></a>`;
        } else {
          body = `<p class="text-sm">${body}</p>`;
        }
        return `<div class="max-w-[90%] ${align}">
          <div class="text-[11px] text-slate-500">${m.author || ''} · ${date}</div>
          <div class="rounded-lg border px-3 py-2 mt-1 ${classes}">
            ${body}
          </div>
        </div>`;
      }).join('');
    }

    function openDetail(sig) {
      const content = document.getElementById('detail-content');
      document.getElementById('detail-title').textContent = sig.titre || 'Signalement';
      content.innerHTML = `
        <div class="text-sm text-slate-700 space-y-1">
          <p><strong>Type:</strong> ${sig.type || ''}</p>
          <p><strong>Site:</strong> ${sig.site || ''}</p>
          <p><strong>Statut:</strong> ${sig.status || 'nouveau'}</p>
          <p><strong>Description:</strong> ${sig.description || ''}</p>
        </div>
        <div>
          <p class="text-xs uppercase text-slate-500 font-semibold mb-1">Photos</p>
          <div id="photos-area" class="grid grid-cols-2 gap-2 text-xs text-slate-500">Chargement...</div>
        </div>
        <div>
          <p class="text-xs uppercase text-slate-500 font-semibold mb-1">Fil de commentaires / rapports</p>
          <div id="msg-area" class="space-y-2 text-sm text-slate-700">Chargement...</div>
          <div class="mt-3 space-y-2">
            <textarea id="msg-input" rows="2" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Ajouter un commentaire ou un rapport..."></textarea>
            <div class="flex items-center gap-2">
              <input type="file" id="msg-file" accept="image/*" class="text-xs">
              <button id="msg-send" class="px-3 py-2 rounded-lg bg-sky-600 text-white text-xs font-semibold hover:bg-sky-700">Envoyer</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('detail-panel').classList.remove('translate-x-full','opacity-0');
      document.getElementById('detail-backdrop').classList.remove('opacity-0','pointer-events-none');
      document.body.style.overflow = 'hidden';

      loadPhotos(sig.id).then(list => {
        const area = document.getElementById('photos-area');
        if (!area) return;
        if (!list.length) { area.innerHTML = '<p class="col-span-2 text-slate-500 text-xs">Aucune photo.</p>'; return; }
        area.innerHTML = list.map(p => `<a href="${p.url}" target="_blank" rel="noopener" class="block rounded-lg overflow-hidden border border-slate-200"><img src="${p.url}" alt="${p.name}" class="w-full h-24 object-cover"></a>`).join('');
      });
      loadMessages(sig.id).then(list => {
        renderMessages(list);
      });

      document.getElementById('msg-send').onclick = async () => {
        const txt = document.getElementById('msg-input').value.trim();
        const file = document.getElementById('msg-file').files[0];
        if (txt) await postMessage(sig.id, txt);
        if (file) await uploadMessageImage(sig.id, file);
        document.getElementById('msg-input').value = '';
        document.getElementById('msg-file').value = '';
        loadMessages(sig.id).then(list => {
          renderMessages(list);
        });
      };
    }
  </script>
</body>
</html>
