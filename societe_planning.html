<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planning - Société</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="vendor/phosphor/index.js"></script>
  <script src="vendor/supabase/supabase.js"></script>
  <style>
    :root { --ink:#0c2f35; --navy:#0f304b; --bg:#f7f5f2; }
    body { font-family:'Outfit',sans-serif; background: radial-gradient(140% 120% at 20% 0%, #f0f7f8 0%, var(--bg) 45%, #fdfdfb 100%); color:#0c2f35; }
    .sidebar { background: linear-gradient(180deg, #0f304b, #0c2f35); color:#e8eef2; }
    .sidebar a { color:#cfd8dc; }
    .sidebar a:hover { background:rgba(255,255,255,0.06); color:#ffffff; }
    .nav-item.active { background:rgba(255,255,255,0.12); color:#ffffff; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
    .card { background:#fff; border:1px solid #e7e5e0; border-radius:18px; box-shadow:0 10px 30px rgba(12,47,53,0.08); }
  </style>
</head>
<body class="flex h-screen">
  <aside class="w-64 sidebar flex flex-col p-6">
    <div class="text-xl font-bold tracking-wide mb-10 text-center text-white">ESPACE <span class="text-sand-200">CLIENT</span></div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard_societe.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph-fill ph-squares-four text-lg"></i><span>Vue d'ensemble</span></a>
      <a href="societe_signalements.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-warning-circle text-lg"></i><span>Suivi des signalements</span></a>
      <a href="societe_clients.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-users text-lg"></i><span>Suivi des clients</span></a>
      <a href="societe_contrats.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-file-text text-lg"></i><span>Suivi des contrats</span></a>
      <a href="societe_rapports.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-chart-bar text-lg"></i><span>Rapports</span></a>
      <a href="societe_salaries.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-id-badge text-lg"></i><span>Suivi des salaries</span></a>
      <a href="societe_pointages.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-timer text-lg"></i><span>Suivi des pointages</span></a>
      <a href="societe_conges.html" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50/5 text-slate-200 transition"><i class="ph ph-calendar-blank text-lg"></i><span>Suivi des demandes de conges</span></a>
      <a href="societe_planning.html" class="flex items-center gap-3 p-3 rounded-xl nav-item active font-medium"><i class="ph ph-calendar-check text-lg"></i><span>Planning salariés</span></a>
    </nav>
    <a href="index.html" class="flex items-center gap-2 text-slate-200 hover:text-white transition mt-auto"><i class="ph ph-sign-out"></i> Deconnexion</a>
  </aside>

  <main class="flex-1 p-6 md:p-8 overflow-y-auto">
    <div class="card p-5 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p class="text-xs font-semibold text-slate-500 uppercase">Planning salariés</p>
          <h1 class="text-2xl font-bold text-slate-900">Assigner des actions</h1>
          <p class="text-sm text-slate-500">Créez des éléments de planning et marquez-les comme validés.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="refresh-btn" class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50"><i class="ph ph-arrow-clockwise"></i> Rafraîchir</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-1 space-y-3">
          <div class="bg-slate-50 border border-slate-100 p-3 rounded-xl">
            <label class="text-xs font-semibold text-slate-500 uppercase">Salarié</label>
            <select id="salarie-select" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
              <option value="">Choisir un salarié</option>
            </select>
          </div>
          <div class="bg-slate-50 border border-slate-100 p-3 rounded-xl space-y-2">
            <label class="text-xs font-semibold text-slate-500 uppercase">Date</label>
            <input id="plan-date" type="date" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            <label class="text-xs font-semibold text-slate-500 uppercase">Titre</label>
            <input id="plan-title" type="text" placeholder="Ex: Intervention site A" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            <label class="text-xs font-semibold text-slate-500 uppercase">Description</label>
            <textarea id="plan-desc" rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Détails de l'action"></textarea>
            <label class="text-xs font-semibold text-slate-500 uppercase">Statut</label>
            <select id="plan-status" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
              <option value="prevu">Prévu</option>
              <option value="valide">Validé</option>
              <option value="fait">Fait</option>
            </select>
            <button id="plan-save" class="w-full mt-2 rounded-lg bg-sky-600 text-white py-2 text-sm font-semibold hover:bg-sky-700">Enregistrer</button>
          </div>
        </div>
        <div class="md:col-span-2 bg-white border border-slate-100 rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-slate-900">Planning du salarié</h3>
            <span id="plan-count" class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600">--</span>
          </div>
          <div id="planning-list" class="space-y-3 text-sm text-slate-700">
            <p class="text-slate-500">Sélectionnez un salarié pour voir son planning.</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none text-sm transition-all duration-300">Message</div>

  <script>
    const supabaseUrl = 'https://fmfylsykljkvyurcprij.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtZnlsc3lrbGprdnl1cmNwcmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ3OTgsImV4cCI6MjA3OTE2MDc5OH0.hfgBflnh-nr1Ljfl5Chkp0y1EbZbm5XiyyDhsQcdSqE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    let societeId = null;
    let selectedSalarieId = null;
    let editId = null;

    function showToast(msg, type='info') {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('opacity-0','pointer-events-none');
      el.style.backgroundColor = type === 'error' ? '#b91c1c' : '#0f172a';
      setTimeout(() => el.classList.add('opacity-0','pointer-events-none'), 2000);
    }

    async function ensureSociete() {
      const { data } = await supabaseClient.auth.getSession();
      const userId = data?.session?.user?.id;
      if (!userId) { showToast('Session requise', 'error'); return null; }
      const { data: so } = await supabaseClient.from('societes').select('id').eq('auth_id', userId).single();
      societeId = so?.id || null;
      if (!societeId) showToast('Société introuvable', 'error');
      return societeId;
    }

    function renderSalaries(list) {
      const sel = document.getElementById('salarie-select');
      sel.innerHTML = '<option value=\"\">Choisir un salarié</option>';
      list.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.prenom || ''} ${s.nom || ''} (${s.ref || 'EMP'})`;
        sel.appendChild(opt);
      });
    }

    async function loadSalaries() {
      if (!societeId) return;
      const { data, error } = await supabaseClient
        .from('salaries')
        .select('id, prenom, nom, ref, contrats!inner(id, societe_id)')
        .eq('contrats.societe_id', societeId);
      if (error) { console.error(error); showToast('Chargement salariés impossible', 'error'); return; }
      renderSalaries(data || []);
    }

    function renderPlanning(list) {
      const container = document.getElementById('planning-list');
      const badge = document.getElementById('plan-count');
      badge.textContent = `${list.length} item${list.length>1?'s':''}`;
      if (!list.length) { container.innerHTML = '<p class="text-slate-500">Aucun élément pour ce salarié.</p>'; return; }
      container.innerHTML = list.map(p => {
        const d = p.date ? new Date(p.date) : null;
        const dateLabel = d ? d.toLocaleDateString() : 'Date N/A';
        const badgeColor = p.status === 'valide' ? 'bg-emerald-100 text-emerald-700' : (p.status === 'fait' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700');
        return `<div class="rounded-xl border border-slate-200 p-3">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-semibold text-slate-900">${p.title || 'Sans titre'}</div>
              <p class="text-xs text-slate-500">${dateLabel}</p>
            </div>
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${badgeColor}">${p.status || 'prevu'}</span>
          </div>
          <p class="text-sm text-slate-700 mt-1">${p.description || ''}</p>
          <div class="flex items-center gap-2 mt-2 text-xs">
            <button class="px-2 py-1 rounded bg-sky-50 text-sky-700 border border-sky-100 hover:bg-sky-100" data-action="edit" data-id="${p.id}"><i class="ph ph-pencil"></i> Modifier</button>
            <button class="px-2 py-1 rounded bg-emerald-50 text-emerald-700 border border-emerald-100 hover:bg-emerald-100" data-action="validate" data-id="${p.id}">Valider</button>
            <button class="px-2 py-1 rounded bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100" data-action="done" data-id="${p.id}">Marquer fait</button>
            <button class="px-2 py-1 rounded bg-rose-50 text-rose-700 border border-rose-100 hover:bg-rose-100" data-action="delete" data-id="${p.id}"><i class="ph ph-trash"></i></button>
          </div>
        </div>`;
      }).join('');
    }

    async function loadPlanning() {
      if (!selectedSalarieId) { document.getElementById('planning-list').innerHTML = '<p class="text-slate-500">Sélectionnez un salarié.</p>'; return; }
      const { data, error } = await supabaseClient
        .from('planning_items')
        .select('*')
        .eq('salarie_id', selectedSalarieId)
        .order('date', { ascending: true });
      if (error) { console.error(error); showToast('Chargement planning impossible', 'error'); return; }
      renderPlanning(data || []);
    }

    function resetForm() {
      editId = null;
      document.getElementById('plan-date').value = '';
      document.getElementById('plan-title').value = '';
      document.getElementById('plan-desc').value = '';
      document.getElementById('plan-status').value = 'prevu';
    }

    async function savePlanning() {
      if (!selectedSalarieId) { showToast('Choisissez un salarié', 'error'); return; }
      const payload = {
        salarie_id: selectedSalarieId,
        date: document.getElementById('plan-date').value || null,
        title: document.getElementById('plan-title').value.trim(),
        description: document.getElementById('plan-desc').value.trim(),
        status: document.getElementById('plan-status').value || 'prevu'
      };
      if (!payload.title) { showToast('Titre requis', 'error'); return; }
      if (editId) {
        const { error } = await supabaseClient.from('planning_items').update(payload).eq('id', editId);
        if (error) { console.error(error); showToast('Maj impossible', 'error'); return; }
        showToast('Planning mis à jour');
      } else {
        const { error } = await supabaseClient.from('planning_items').insert([payload]);
        if (error) { console.error(error); showToast('Création impossible', 'error'); return; }
        showToast('Planning créé');
      }
      resetForm();
      loadPlanning();
    }

    async function updateStatus(id, status) {
      const { error } = await supabaseClient.from('planning_items').update({ status }).eq('id', id);
      if (error) { console.error(error); showToast('Maj statut impossible', 'error'); return; }
      showToast('Statut mis à jour');
      loadPlanning();
    }

    async function deletePlanning(id) {
      if (!confirm('Supprimer cet élément ?')) return;
      const { error } = await supabaseClient.from('planning_items').delete().eq('id', id);
      if (error) { console.error(error); showToast('Suppression impossible', 'error'); return; }
      showToast('Supprimé');
      loadPlanning();
    }

    document.getElementById('salarie-select').addEventListener('change', (e) => {
      selectedSalarieId = e.target.value ? parseInt(e.target.value, 10) : null;
      resetForm();
      loadPlanning();
    });
    document.getElementById('plan-save').addEventListener('click', savePlanning);
    document.getElementById('refresh-btn').addEventListener('click', loadPlanning);
    document.getElementById('planning-list').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = parseInt(btn.dataset.id, 10);
      const action = btn.dataset.action;
      if (action === 'edit') {
        const card = btn.closest('div.rounded-xl');
        editId = id;
        document.getElementById('plan-title').value = card.querySelector('.font-semibold')?.textContent || '';
        document.getElementById('plan-desc').value = card.querySelector('.text-sm.text-slate-700')?.textContent || '';
        document.getElementById('plan-status').value = card.querySelector('span.px-2')?.textContent?.toLowerCase() || 'prevu';
      } else if (action === 'validate') {
        updateStatus(id, 'valide');
      } else if (action === 'done') {
        updateStatus(id, 'fait');
      } else if (action === 'delete') {
        deletePlanning(id);
      }
    });

    (async () => {
      await ensureSociete();
      if (societeId) await loadSalaries();
    })();
  </script>
</body>
</html>
