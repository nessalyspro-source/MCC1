﻿<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin - Tableau de bord</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="vendor/phosphor/index.js"></script>
  <script src="vendor/supabase/supabase.js"></script>
  <style>
    :root { --ink:#0c2f35; --navy:#0f304b; --red:#ce3c35; --sand:#b58a64; --bg:#f7f5f2; }
    body { font-family:'Outfit',sans-serif; background: radial-gradient(120% 100% at 10% 0%, #eef4f6 0%, #f8f5f0 55%, #fdfdfb 100%); color: var(--ink); }
    .sidebar { background: linear-gradient(180deg, #0f304b, #0c2f35); color:#e8eef2; }
    .nav-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:12px; color:#cfd8dc; transition:all .15s ease; }
    .nav-item.active, .nav-item:hover { background: rgba(255,255,255,0.1); color:#fff; }
    .card { background:#fff; border:1px solid #e6e2dc; border-radius:18px; box-shadow:0 16px 50px rgba(12,47,53,0.08); }
    .pill { background: rgba(12,47,53,0.08); color: var(--navy); padding:8px 12px; border-radius:999px; font-weight:600; font-size:12px; letter-spacing:0.04em; display:inline-flex; align-items:center; gap:8px; }
    .gradient { background: linear-gradient(120deg, var(--navy), var(--ink)); }
  </style>
</head>
<body class="flex min-h-screen">
  <aside class="w-64 sidebar flex flex-col p-6 gap-4">
    <div class="text-2xl font-bold tracking-wide mb-6 text-center">SUPER <span class="text-sand-200">ADMIN</span></div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard_admin.html" class="nav-item active"><i class="ph-fill ph-squares-four text-lg"></i><span>Tableau de bord</span></a>
      <a href="super_admin_societes.html" class="nav-item"><i class="ph ph-buildings text-lg"></i><span>Sociétés</span></a>
      <a href="super_admin_facturation.html" class="nav-item"><i class="ph ph-receipt text-lg"></i><span>Facturation</span></a>
    </nav>
    <a href="super_admin_login.html" class="flex items-center gap-2 text-slate-300 hover:text-white transition mt-auto"><i class="ph ph-sign-out"></i> Déconnexion</a>
  </aside>

  <main class="flex-1 px-8 py-10 max-w-7xl mx-auto w-full">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
      <div class="space-y-2">
        <span class="pill"><i class="ph-bold ph-crown"></i> Super Admin</span>
        <h1 class="text-3xl font-bold text-slate-900">Tableau de bord global</h1>
        <p class="text-sm text-slate-600">Suivi des sociétés clientes (portails), revenu récurrent et activité.</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <p class="text-sm font-semibold text-slate-700">Compte connecté</p>
          <p id="connected-email" class="text-xs text-slate-500">-</p>
        </div>
        <div class="w-12 h-12 rounded-full gradient text-white flex items-center justify-center font-bold text-lg">SA</div>
      </div>
    </header>

    <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="card p-5">
        <p class="text-xs font-semibold text-slate-500 uppercase">Sociétés créées</p>
        <p id="stat-societes" class="text-3xl font-bold text-slate-900">-</p>
        <p class="text-sm text-slate-500">Portails clients créés par le super admin</p>
      </div>
      <div class="card p-5">
        <p class="text-xs font-semibold text-slate-500 uppercase">Sociétés actives</p>
        <p id="stat-actifs" class="text-3xl font-bold text-emerald-700">-</p>
        <p class="text-sm text-slate-500">Statut actif sur la base</p>
      </div>
      <div class="card p-5">
        <p class="text-xs font-semibold text-slate-500 uppercase">Revenu mensuel</p>
        <p id="stat-revenu" class="text-3xl font-bold text-slate-900">-</p>
        <p class="text-sm text-slate-500">29 EUR / société active</p>
      </div>
      <div class="card p-5">
        <p class="text-xs font-semibold text-slate-500 uppercase">Contrats</p>
        <p id="stat-contrats" class="text-3xl font-bold text-slate-900">-</p>
        <p class="text-sm text-slate-500">Contrats totaux (toutes sociétés)</p>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card p-5 lg:col-span-2">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold text-slate-500 uppercase">Sociétés récentes</p>
            <h2 class="text-lg font-semibold text-slate-900">Liste</h2>
          </div>
          <a href="super_admin_societes.html" class="text-sm font-semibold text-sky-700 hover:underline">Gérer</a>
        </div>
        <div id="societes-list" class="divide-y divide-slate-200">
          <p class="text-sm text-slate-500 py-3">Chargement...</p>
        </div>
      </div>
      <div class="card p-5">
        <p class="text-xs font-semibold text-slate-500 uppercase">Portails actifs</p>
        <h2 class="text-2xl font-bold text-slate-900 mb-2" id="stat-portails">-</h2>
        <p class="text-sm text-slate-500 mb-4">Sociétés pouvant gérer leurs clients/contrats</p>
        <div class="space-y-2 text-sm text-slate-600">
          <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-400"></span>Accès réservé à la société</div>
          <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-slate-400"></span>Super admin en supervision</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const supabaseUrl = 'https://fmfylsykljkvyurcprij.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtZnlsc3lrbGprdnl1cmNwcmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ3OTgsImV4cCI6MjA3OTE2MDc5OH0.hfgBflnh-nr1Ljfl5Chkp0y1EbZbm5XiyyDhsQcdSqE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    const pricePerSociete = 29;

    async function loadStats() {
      try {
        const [socRes, contratsRes] = await Promise.all([
          supabaseClient.from('societes').select('*'),
          supabaseClient.from('contrats').select('id')
        ]);
        if (socRes.error) throw socRes.error;
        const societes = socRes.data || [];
        const contrats = contratsRes.data || [];

        const totalSocietes = societes.length;
        const actifs = societes.filter(s => (s.statut || '').toLowerCase() === 'actif' || s.statut === true || s.statut === 1).length;
        const revenu = actifs * pricePerSociete;

        document.getElementById('stat-societes').textContent = totalSocietes;
        document.getElementById('stat-actifs').textContent = actifs;
        document.getElementById('stat-revenu').textContent = `${revenu.toLocaleString('fr-FR', { minimumFractionDigits: 2 })} EUR`;
        document.getElementById('stat-contrats').textContent = contrats.length;
        document.getElementById('stat-portails').textContent = actifs;

        const list = document.getElementById('societes-list');
        if (!societes.length) { list.innerHTML = '<p class="text-sm text-slate-500 py-3">Aucune société enregistrée.</p>'; return; }
        const sorted = societes.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0)).slice(0,6);
        list.innerHTML = sorted.map(s => `
          <div class="py-3 flex items-center justify-between">
            <div>
              <p class="text-sm font-semibold text-slate-800">${s.nom || 'Société'}</p>
              <p class="text-xs text-slate-500">${s.email_contact || ''}</p>
            </div>
            <span class="text-[11px] px-2 py-1 rounded-full ${((s.statut || '').toLowerCase() === 'actif' || s.statut === true || s.statut === 1) ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${s.statut || 'actif'}</span>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        document.getElementById('societes-list').innerHTML = '<p class="text-sm text-red-600 py-3">Table "societes" manquante ou erreur.</p>';
      }
    }

    function setConnectedEmail() {
      try {
        const session = localStorage.getItem('supabaseSession');
        if (session) {
          const parsed = JSON.parse(session);
          const email = parsed?.user?.email || '';
          if (email) document.getElementById('connected-email').textContent = email;
        }
      } catch(e) { console.warn(e); }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setConnectedEmail();
      loadStats();
    });
  </script>
</body>
</html>



